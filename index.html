<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NIKKE 캐릭터 선택 (Step/Element 필터)</title>
  <style>
    :root { color-scheme: dark; }
    body { margin: 20px; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; background:#0f1115; color:#e7e9ee; }
    h1 { margin: 0 0 12px; font-size: 20px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin: 10px 0; }
    .panel { background:#151924; border:1px solid #262b3a; border-radius:12px; padding:12px; }
    .panel h2 { margin:0 0 10px; font-size:14px; color:#b8c0ff; }
    .chips { display:flex; gap:8px; flex-wrap:wrap; }
    .chip {
      border:1px solid #2b3143; background:#121522; color:#d7dbff;
      padding:6px 10px; border-radius:999px; cursor:pointer; user-select:none;
      font-size: 13px;
    }
    .chip.active { background:#2a2f44; border-color:#6a76ff; color:#ffffff; }
    .chip:hover { filter: brightness(1.08); }
    input[type="search"]{
      background:#0f1320; border:1px solid #2b3143; border-radius:10px;
      color:#e7e9ee; padding:10px 12px; min-width: 240px;
    }
    .layout { display:grid; grid-template-columns: 1.2fr 0.8fr; gap:12px; align-items:start; }
    @media (max-width: 980px){ .layout { grid-template-columns: 1fr; } }
    .meta { color:#a7b0c2; font-size: 12px; }
    .list {
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap:10px;
    }
    .card {
      background:#121522; border:1px solid #262b3a; border-radius:12px;
      padding:10px; cursor:pointer; user-select:none;
      display:flex; flex-direction:column; gap:6px;
    }
    .card:hover { border-color:#4d5b8a; }
    .card.selected { border-color:#6a76ff; box-shadow: 0 0 0 1px rgba(106,118,255,.25) inset; }
    .name { font-weight:700; font-size: 14px; }
    .tags { display:flex; gap:6px; flex-wrap:wrap; }
    .tag { font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid #2b3143; color:#cfd6ff; }
    .tag.step { color:#b9ffdf; border-color:#2d4a3e; }
    .tag.el { color:#ffd6b1; border-color:#4a3a2d; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    button {
      background:#1a2030; border:1px solid #2b3143; color:#e7e9ee;
      padding:8px 10px; border-radius:10px; cursor:pointer;
    }
    button:hover { filter: brightness(1.08); }
    .selectedList { display:flex; flex-direction:column; gap:8px; }
    .selectedItem {
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding:8px 10px;
      background:#121522; border:1px solid #262b3a; border-radius:10px;
      font-size: 13px;
    }
    .selectedItem .left { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .muted { color:#8d97ad; font-size:12px; }
    .warn { color:#ffd6b1; }
  </style>
</head>
<body>
  <h1>캐릭터 선택 (Step / Element 필터)</h1>

  <div class="row panel">
    <div style="flex:1; min-width: 280px;">
      <h2>필터</h2>

      <div class="row" style="margin: 6px 0;">
        <div class="meta">Step</div>
        <div class="chips" id="stepChips"></div>
      </div>

      <div class="row" style="margin: 6px 0;">
        <div class="meta">Element</div>
        <div class="chips" id="elementChips"></div>
      </div>

      <div class="row" style="margin: 6px 0;">
        <input id="searchBox" type="search" placeholder="이름 검색 (예: 도로시, 앨리스)" />
        <div class="meta" id="countInfo">로딩 중...</div>
      </div>

      <div class="row" style="margin: 6px 0;">
        <span class="muted">※ 카드 클릭 = 선택/해제</span>
      </div>
    </div>

    <div style="min-width: 260px;">
      <h2>데이터 로드</h2>
      <div class="row">
        <button id="btnReload">name.json 다시 로드</button>
        <button id="btnResetFilters">필터 초기화</button>
      </div>
      <div class="muted">
        기본 경로: <code>./data/name.json</code><br/>
        (GitHub Pages에선 <code>data/name.json</code>로 올려두면 됨)
      </div>
      <div class="row" style="margin-top:10px;">
        <input id="fileInput" type="file" accept="application/json" />
      </div>
      <div class="muted">※ fetch가 막히거나 테스트할 때 로컬 파일로도 로드 가능</div>
      <div id="status" class="muted" style="margin-top:10px;"></div>
    </div>
  </div>

  <div class="layout">
    <div class="panel">
      <h2>캐릭터 목록</h2>
      <div class="list" id="characterList"></div>
    </div>

    <div class="panel">
      <h2>선택된 캐릭터</h2>
      <div class="actions" style="margin-bottom:10px;">
        <button id="btnClearSelected">선택 전체 해제</button>
        <button id="btnCopySelected">선택 이름 복사</button>
      </div>
      <div class="selectedList" id="selectedList"></div>
      <div class="muted" id="selectedMeta" style="margin-top:10px;"></div>
    </div>
  </div>

  <script>
    // ====== 설정 ======
    const DATA_URL = "./data/name.json";

    const STEP_FILTERS = [
      { label: "전체", value: "ALL" },
      { label: "1", value: "1" },
      { label: "2", value: "2" },
      { label: "3", value: "3" },
      { label: "A", value: "A" },
    ];

    const ELEMENT_FILTERS = [
      { label: "전체", value: "ALL" },
      { label: "Iron", value: "Iron" },
      { label: "Wind", value: "Wind" },
      { label: "Electronic", value: "Electronic" },
      { label: "Fire", value: "Fire" },
      { label: "Water", value: "Water" },
    ];

    // ====== 상태 ======
    /** @type {{ id:number|string, name:string, step:string, element:string, order?:number }[]} */
    let allChars = [];
    let activeStep = "ALL";
    let activeElement = "ALL";
    let searchText = "";

    /** @type {Set<number|string>} */
    const selectedIds = new Set();

    // ====== DOM ======
    const stepChips = document.getElementById("stepChips");
    const elementChips = document.getElementById("elementChips");
    const searchBox = document.getElementById("searchBox");
    const countInfo = document.getElementById("countInfo");
    const listEl = document.getElementById("characterList");
    const selectedListEl = document.getElementById("selectedList");
    const selectedMetaEl = document.getElementById("selectedMeta");
    const statusEl = document.getElementById("status");

    const btnReload = document.getElementById("btnReload");
    const btnResetFilters = document.getElementById("btnResetFilters");
    const btnClearSelected = document.getElementById("btnClearSelected");
    const btnCopySelected = document.getElementById("btnCopySelected");
    const fileInput = document.getElementById("fileInput");

    function setStatus(msg, isWarn=false){
      statusEl.textContent = msg;
      statusEl.className = isWarn ? "muted warn" : "muted";
    }

    // ====== 데이터 파싱 ======
    function mapUseBurstSkillToStep(useBurst) {
      // JSON에는 Step1/2/3 또는 AllStep 같은 값이 들어옴 :contentReference[oaicite:2]{index=2}
      if (!useBurst) return "";
      if (useBurst === "AllStep") return "A"; // 사용자 요구: A
      const m = String(useBurst).match(/Step(\d)/i);
      return m ? m[1] : "";
    }

    function parseCharacterList(raw) {
      if (!Array.isArray(raw)) throw new Error("JSON 최상위는 배열이어야 합니다.");

      const out = [];
      for (const it of raw) {
        if (!it) continue;
        if (it.is_visible === false) continue;

        const name = it?.name_localkey?.name ?? ""; // name_localkey.name :contentReference[oaicite:3]{index=3}
        const element = it?.element_id?.element?.element ?? ""; // element_id.element.element :contentReference[oaicite:4]{index=4}
        const step = mapUseBurstSkillToStep(it?.use_burst_skill);
        const id = it?.id ?? name;
        const order = typeof it?.order === "number" ? it.order : undefined;

        if (!name || !element || !step) continue;

        // element은 5종만 쓰기로 했으니, 혹시 다른 값이면 스킵
        if (!["Iron","Wind","Electronic","Fire","Water"].includes(element)) continue;
        if (!["1","2","3","A"].includes(step)) continue;

        out.push({ id, name, element, step, order });
      }

      // 보기 좋게 order 우선, 없으면 이름순
      out.sort((a,b) => (a.order ?? 1e9) - (b.order ?? 1e9) || a.name.localeCompare(b.name, "ko"));

      return out;
    }

    async function loadDataFromUrl() {
      setStatus("name.json 로딩 중...");
      const res = await fetch(DATA_URL, { cache: "no-store" });
      if (!res.ok) throw new Error(`fetch 실패: ${res.status} ${res.statusText}`);
      const raw = await res.json();
      allChars = parseCharacterList(raw);
      setStatus(`로드 완료: ${allChars.length}명`);
      renderAll();
    }

    async function loadDataFromFile(file) {
      const text = await file.text();
      const raw = JSON.parse(text);
      allChars = parseCharacterList(raw);
      setStatus(`로컬 파일 로드 완료: ${allChars.length}명`);
      renderAll();
    }

    // ====== 필터 UI ======
    function renderChips(container, items, activeValue, onClick) {
      container.innerHTML = "";
      for (const it of items) {
        const el = document.createElement("div");
        el.className = "chip" + (it.value === activeValue ? " active" : "");
        el.textContent = it.label;
        el.dataset.value = it.value;
        el.addEventListener("click", () => onClick(it.value));
        container.appendChild(el);
      }
    }

    function applyFilters(list) {
      const st = searchText.trim();
      return list.filter(x => {
        if (activeStep !== "ALL" && x.step !== activeStep) return false;
        if (activeElement !== "ALL" && x.element !== activeElement) return false;
        if (st && !x.name.includes(st)) return false;
        return true;
      });
    }

    // ====== 렌더링 ======
    function renderList() {
      const filtered = applyFilters(allChars);
      countInfo.textContent = `표시: ${filtered.length} / 전체: ${allChars.length}`;

      listEl.innerHTML = "";
      for (const c of filtered) {
        const card = document.createElement("div");
        card.className = "card" + (selectedIds.has(c.id) ? " selected" : "");
        card.title = "클릭하여 선택/해제";

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = c.name;

        const tags = document.createElement("div");
        tags.className = "tags";

        const tStep = document.createElement("span");
        tStep.className = "tag step";
        tStep.textContent = `Step ${c.step}`;

        const tEl = document.createElement("span");
        tEl.className = "tag el";
        tEl.textContent = c.element;

        tags.appendChild(tStep);
        tags.appendChild(tEl);

        card.appendChild(name);
        card.appendChild(tags);

        card.addEventListener("click", () => {
          toggleSelect(c.id);
        });

        listEl.appendChild(card);
      }
    }

    function renderSelected() {
      const selected = allChars.filter(c => selectedIds.has(c.id));

      selectedListEl.innerHTML = "";
      for (const c of selected) {
        const row = document.createElement("div");
        row.className = "selectedItem";

        const left = document.createElement("div");
        left.className = "left";

        const nm = document.createElement("span");
        nm.textContent = c.name;

        const st = document.createElement("span");
        st.className = "tag step";
        st.textContent = `Step ${c.step}`;

        const el = document.createElement("span");
        el.className = "tag el";
        el.textContent = c.element;

        left.appendChild(nm);
        left.appendChild(st);
        left.appendChild(el);

        const btn = document.createElement("button");
        btn.textContent = "삭제";
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          selectedIds.delete(c.id);
          renderAll();
        });

        row.appendChild(left);
        row.appendChild(btn);
        selectedListEl.appendChild(row);
      }

      const lines = selected.map(x => x.name).join("\n");
      selectedMetaEl.textContent = selected.length
        ? `선택 ${selected.length}명\n(복사 버튼을 누르면 이름이 줄바꿈으로 복사됩니다.)`
        : "선택된 캐릭터가 없습니다.";
      selectedMetaEl.dataset.clip = lines;
    }

    function renderFilters() {
      renderChips(stepChips, STEP_FILTERS, activeStep, (v) => {
        activeStep = v;
        renderAll();
      });

      renderChips(elementChips, ELEMENT_FILTERS, activeElement, (v) => {
        activeElement = v;
        renderAll();
      });
    }

    function renderAll() {
      renderFilters();
      renderList();
      renderSelected();
    }

    // ====== 선택 ======
    function toggleSelect(id) {
      if (selectedIds.has(id)) selectedIds.delete(id);
      else selectedIds.add(id);
      renderAll();
    }

    // ====== 이벤트 ======
    searchBox.addEventListener("input", () => {
      searchText = searchBox.value || "";
      renderList(); // 리스트만 다시
    });

    btnReload.addEventListener("click", async () => {
      try { await loadDataFromUrl(); }
      catch (e) { setStatus(String(e?.message || e), true); }
    });

    btnResetFilters.addEventListener("click", () => {
      activeStep = "ALL";
      activeElement = "ALL";
      searchText = "";
      searchBox.value = "";
      renderAll();
    });

    btnClearSelected.addEventListener("click", () => {
      selectedIds.clear();
      renderAll();
    });

    btnCopySelected.addEventListener("click", async () => {
      const text = selectedMetaEl.dataset.clip || "";
      if (!text) {
        setStatus("복사할 선택 항목이 없습니다.", true);
        return;
      }
      try {
        await navigator.clipboard.writeText(text);
        setStatus("선택 이름을 클립보드에 복사했습니다.");
      } catch {
        // clipboard 실패 시 fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        setStatus("선택 이름을 복사했습니다. (fallback)");
      }
    });

    fileInput.addEventListener("change", async (e) => {
      const f = e.target.files?.[0];
      if (!f) return;
      try { await loadDataFromFile(f); }
      catch (err) { setStatus("로컬 파일 파싱 실패: " + (err?.message || String(err)), true); }
    });

    // ====== 시작 ======
    (async function init(){
      try {
        await loadDataFromUrl();
      } catch (e) {
        setStatus(
          "name.json fetch 실패. GitHub Pages에 data/name.json이 있는지 확인하거나, 아래 파일 업로드로 로드하세요.\n" +
          String(e?.message || e),
          true
        );
        // 필터/화면은 빈 상태로라도 렌더
        allChars = [];
        renderAll();
      }
    })();
  </script>
</body>
</html>
